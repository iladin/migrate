AT_INIT([CALL tests])


AT_SETUP([Ambiguous AND/OR (1)])

AT_DATA([prog.cob], [
IDENTIFICATION  DIVISION.
PROGRAM-ID.     prog.
PROCEDURE       DIVISION.
  IF 3 = 1 AND 2 OR 3
    DISPLAY "OK".
  STOP RUN.
])

AT_CHECK([cobc -C prog.cob], [0], ,
[prog.cob:6: warning: suggest parentheses around AND within OR
])

AT_CLEANUP


AT_SETUP([Ambiguous AND/OR (2)])

AT_DATA([prog.cob], [
IDENTIFICATION  DIVISION.
PROGRAM-ID.     prog.
PROCEDURE       DIVISION.
  IF 3 = 1 OR 2 AND 3
    DISPLAY "NO".
  STOP RUN.
])

AT_CHECK([cobc -C prog.cob], [0], ,
[prog.cob:6: warning: suggest parentheses around AND within OR
])

AT_CLEANUP


AT_SETUP([CALL m1. CALL m2. CALL m1.])

AT_DATA([m1.cob], [
IDENTIFICATION  DIVISION.
PROGRAM-ID.     m1.
DATA            DIVISION.
WORKING-STORAGE SECTION.
01 X            PIC 9(4).
PROCEDURE       DIVISION.
  COMPUTE X = 1 + 2.
  DISPLAY X.
])

AT_DATA([m2.cob], [
IDENTIFICATION  DIVISION.
PROGRAM-ID.     m2.
DATA            DIVISION.
WORKING-STORAGE SECTION.
01 X            PIC 9(4).
PROCEDURE       DIVISION.
  COMPUTE X = 3 + 4.
  DISPLAY X.
])

AT_DATA([caller.cob], [
IDENTIFICATION  DIVISION.
PROGRAM-ID.     caller.
PROCEDURE       DIVISION.
  CALL "m1".
  CALL "m2".
  CALL "m1".
  STOP RUN.
])

AT_CHECK([cobc -m m1.cob], [0])
AT_CHECK([cobc -m m2.cob], [0])
AT_CHECK([cobc -main caller.cob], [0])

AT_CHECK([./caller], [0],
[0003
0007
0003
])

AT_CLEANUP


AT_SETUP([CALL BY CONTENT LENGTH])

AT_DATA([caller.cob], [
IDENTIFICATION  DIVISION.
PROGRAM-ID.     caller.
DATA            DIVISION.
WORKING-STORAGE SECTION.
01 X            PIC X(4).
PROCEDURE       DIVISION.
  MOVE "abcd" TO X.
  CALL "callee" USING X BY CONTENT LENGTH OF X.
  STOP RUN.
])

# callee.c
AT_DATA([callee.c], [
#include <stdio.h>
int callee (char *str, int *len)
{
  fwrite (str, *len, 1, stdout);
  return 0;
}
])

# compile
cobc -c -static -main caller.cob
cc -c callee.c
cobc caller.o callee.o

# check
AT_CHECK([./caller], [0], [abcd])

AT_CLEANUP


AT_SETUP([INITIALIZE OCCURS with numeric edited])

AT_DATA([prog.cob], [
IDENTIFICATION  DIVISION.
PROGRAM-ID.     prog.
DATA            DIVISION.
WORKING-STORAGE SECTION.
01 G1.
  02 G2         OCCURS 5.
    03 X        PIC Z9.
PROCEDURE       DIVISION.
  INITIALIZE G1.
  DISPLAY G1.
  STOP RUN.
])

AT_CHECK([cobc -main prog.cob], [0])
AT_CHECK([./prog], [0],
[ 0 0 0 0 0
])

AT_CLEANUP
